#!/bin/sh
#
# Build and test Git
#

. ${0%/*}/lib.sh

case "$CI_OS_NAME" in
windows*) cmd //c mklink //j t\\.prove "$(cygpath -aw "$cache_dir/.prove")";;
*) ln -s "$cache_dir/.prove" t/.prove;;
esac

case "$jobname" in
linux-clang-SANITIZE)
	make SANITIZE=address,leak CFLAGS="-O0 -g"
	;;
*)
	make
	;;
esac
case "$jobname" in
linux-gcc)
	export GIT_TEST_DEFAULT_INITIAL_BRANCH_NAME=main
	make test
	export GIT_TEST_SPLIT_INDEX=yes
	export GIT_TEST_MERGE_ALGORITHM=recursive
	export GIT_TEST_FULL_IN_PACK_ARRAY=true
	export GIT_TEST_OE_SIZE=10
	export GIT_TEST_OE_DELTA_SIZE=5
	export GIT_TEST_COMMIT_GRAPH=1
	export GIT_TEST_COMMIT_GRAPH_CHANGED_PATHS=1
	export GIT_TEST_MULTI_PACK_INDEX=1
	export GIT_TEST_ADD_I_USE_BUILTIN=1
	export GIT_TEST_DEFAULT_INITIAL_BRANCH_NAME=master
	export GIT_TEST_WRITE_REV_INDEX=1
	export GIT_TEST_CHECKOUT_WORKERS=2
	make test
	;;
linux-clang)
	export GIT_TEST_DEFAULT_HASH=sha1
	make test
	export GIT_TEST_DEFAULT_HASH=sha256
	make test
	;;
linux-clang-SANITIZE)
	GIT_SKIP_TEST="t0004 t0006 t0009 t0012 t0014 t0019 t0020 t0021 t0022 t0023 t0028 t0040 t0041 t0050 t0056 t0060 t0062 t0064 t0068 t0070 t0090 t0095 t0100 t0101 t0110 t0203 t0210 t0211 t0212 t0300 t0301 t0302 t0410 t0500 t1001 t1004 t1005 t1006 t1007 t1008 t1011 t1013 t1015 t1020 t1021 t1050 t1051 t1060 t1090 t1091 t1092 t1301 t1302 t1304 t1305 t1306 t1350 t1400 t1401 t1402 t1403 t1404 t1405 t1406 t1407 t1408 t1409 t1410 t1411 t1412 t1413 t1414 t1415 t1416 t1430 t1450 t1500 t1501 t1502 t1505 t1507 t1508 t1511 t1512 t1514 t1700 t2006 t2007 t2008 t2009 t2010 t2011 t2012 t2013 t2014 t2015 t2016 t2017 t2018 t2019 t2020 t2021 t2022 t2023 t2024 t2025 t2026 t2027 t2030 t2060 t2070 t2071 t2072 t2080 t2082 t2106 t2203 t2400 t2401 t2402 t2403 t2405 t2406 t3001 t3005 t3007 t3009 t3010 t3011 t3012 t3020 t3040 t3050 t3060 t3200 t3201 t3202 t3203 t3204 t3205 t3206 t3210 t3301 t3304 t3305 t3306 t3307 t3308 t3309 t3310 t3311 t3400 t3401 t3402 t3403 t3404 t3405 t3406 t3407 t3408 t3409 t3410 t3411 t3412 t3413 t3414 t3415 t3416 t3417 t3418 t3419 t3420 t3421 t3422 t3423 t3424 t3425 t3426 t3427 t3428 t3429 t3430 t3431 t3432 t3433 t3434 t3435 t3436 t3437 t3500 t3501 t3502 t3503 t3504 t3505 t3506 t3507 t3508 t3509 t3510 t3511 t3512 t3513 t3514 t3600 t3602 t3700 t3701 t3705 t3800 t3900 t3901 t3903 t3904 t3905 t3906 t3907 t3908 t3909 t3920 t4001 t4005 t4008 t4013 t4014 t4015 t4016 t4017 t4018 t4021 t4022 t4023 t4028 t4030 t4031 t4036 t4038 t4039 t4041 t4042 t4043 t4044 t4045 t4047 t4048 t4051 t4052 t4053 t4055 t4056 t4057 t4058 t4059 t4060 t4061 t4064 t4065 t4066 t4067 t4068 t4103 t4104 t4107 t4108 t4111 t4113 t4114 t4115 t4117 t4120 t4121 t4122 t4124 t4125 t4127 t4131 t4135 t4137 t4138 t4140 t4150 t4151 t4152 t4153 t4200 t4201 t4202 t4203 t4204 t4205 t4206 t4207 t4208 t4209 t4210 t4211 t4212 t4213 t4214 t4215 t4216 t4252 t4253 t4254 t4255 t4256 t4257 t4258 t5000 t5001 t5003 t5004 t5100 t5150 t5300 t5301 t5302 t5303 t5304 t5305 t5306 t5309 t5310 t5311 t5312 t5313 t5314 t5315 t5316 t5317 t5318 t5319 t5320 t5321 t5322 t5323 t5324 t5325 t5400 t5401 t5402 t5403 t5404 t5405 t5406 t5407 t5408 t5409 t5410 t5411 t5500 t5501 t5502 t5503 t5504 t5505 t5506 t5507 t5509 t5510 t5511 t5512 t5513 t5514 t5515 t5516 t5517 t5518 t5519 t5520 t5521 t5522 t5523 t5524 t5525 t5526 t5527 t5528 t5529 t5530 t5531 t5532 t5533 t5534 t5535 t5536 t5537 t5538 t5539 t5540 t5541 t5542 t5543 t5544 t5545 t5546 t5547 t5548 t5550 t5551 t5552 t5553 t5554 t5560 t5561 t5562 t5570 t5571 t5572 t5573 t5581 t5582 t5600 t5601 t5604 t5605 t5606 t5607 t5609 t5610 t5611 t5612 t5613 t5614 t5616 t5617 t5618 t5700 t5701 t5702 t5703 t5705 t5801 t5802 t5810 t5811 t5812 t5813 t5814 t5815 t5900 t6000 t6001 t6002 t6003 t6004 t6006 t6007 t6008 t6009 t6010 t6011 t6012 t6013 t6014 t6016 t6017 t6018 t6019 t6020 t6030 t6040 t6041 t6050 t6060 t6100 t6101 t6110 t6111 t6112 t6113 t6114 t6115 t6120 t6130 t6131 t6132 t6133 t6134 t6135 t6200 t6300 t6301 t6302 t6400 t6401 t6402 t6403 t6404 t6405 t6406 t6407 t6408 t6409 t6411 t6412 t6413 t6414 t6415 t6416 t6417 t6418 t6422 t6423 t6424 t6425 t6426 t6427 t6428 t6430 t6431 t6432 t6433 t6434 t6435 t6436 t6437 t6438 t6439 t6500 t6501 t6600 t7001 t7003 t7004 t7005 t7006 t7007 t7008 t7010 t7011 t7012 t7030 t7060 t7061 t7063 t7064 t7102 t7104 t7105 t7106 t7107 t7110 t7111 t7112 t7113 t7201 t7300 t7301 t7400 t7401 t7402 t7403 t7406 t7407 t7408 t7409 t7411 t7412 t7413 t7414 t7416 t7417 t7418 t7419 t7420 t7421 t7450 t7500 t7501 t7502 t7503 t7504 t7505 t7506 t7507 t7508 t7509 t7510 t7512 t7513 t7514 t7516 t7517 t7519 t7520 t7521 t7525 t7600 t7601 t7602 t7603 t7604 t7605 t7606 t7608 t7610 t7611 t7612 t7614 t7700 t7701 t7702 t7703 t7800 t7810 t7811 t7814 t7815 t7817 t7900 t8001 t8002 t8003 t8004 t8005 t8006 t8007 t8008 t8009 t8010 t8011 t8012 t8013 t8014 t9001 t9002 t9003 t9004 t9300 t9301 t9304 t9350 t9351 t9500 t9700 t9902 t9903" \
	make test
	;;
linux-gcc-4.8)
	# Don't run the tests; we only care about whether Git can be
	# built with GCC 4.8, as it errors out on some undesired (C99)
	# constructs that newer compilers seem to quietly accept.
	;;
*)
	make test
	;;
esac

check_unignored_build_artifacts

save_good_tree
